---
title: "Pronósticos con Metodos BenchMark"
author: "Francisco Uriel Ledezma Chávez"
format: html
editor: visual
---

## Introducción

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(fpp3)
```

```{r}
aus_production |>
  autoplot(Gas)
```

## Train/Test

Vamos a hacer pronósticos a 3 años por lo que necesitamos dejar los últimos 3 años como el conjunto de test.

```{r}
gas_train <- aus_production |>
  filter_index(. ~ "2007 Q2")

gas_train
```

##Visualize

```{r}
gas_train |>
  autoplot(Gas)
```

```{r}
gas_train |>
  autoplot(log(Gas))
```

Parece que todavía no es completamente estable (ahora al inicio la varianza es mayor).

Probemos con Box-Con

```{r}
gas_lambda <- gas_train |>
  features(Gas, guerrero) |>
  pull()

gas_lambda

gas_train |>
  autoplot(box_cox(Gas, gas_lambda))
```

Parece que mejora un poco.

### Descomposición STL

Vamos a separar la serie transformada usando STL.

```{r}
gas_train |>
  model(
    stl = STL(box_cox(Gas, gas_lambda) ~ season(window = "periodic"), robust = TRUE)
) |>
  components() |>
autoplot()
```

## Especificación de modelos

Primero vamos a probar los 4 modelos benchmark por separado, y posteriormente vamos a crear un modelo a partir de la descomposición que hicmos arriba.

```{r}
gas_fit <- gas_train |>
  model(
    media = MEAN(box_cox(Gas, gas_lambda)),
    naive = NAIVE(box_cox(Gas, gas_lambda)),
    snaive = SNAIVE(box_cox(Gas, gas_lambda)),
    drift = RW(box_cox(Gas, gas_lambda) ~ drift())
  )
  
gas_fit
```

## Evaluación

```{r}
gas_aug <- gas_fit |>
  augment()

gas_fit |>
  select(media) |>
  gg_tsresiduals()

gas_aug |>
  ggplot(aes(x = Quarter, y = .innov)) +
  geom_line() + 
  facet_wrap(vars(.model), scales = "free_y") +
  labs(title = "Innovaciones de los modelos benchmark")
```

## Prónostico a partir de descomposición

```{r}
gas_fit_stl <- gas_train |>
  model(
    stlf = decomposition_model (
      STL(box_cox(Gas, gas_lambda), robust = TRUE),
      SNAIVE(season_year),
      RW(season_adjust ~ drift())
    )
  )

gas_fit_stl
```

```{r}
gas_fit_stl |>
  gg_tsresiduals()
```

```{r}
gas_fit_todos <- gas_train |>
  model(
    media = MEAN(box_cox(Gas, gas_lambda)),
    naive = NAIVE(box_cox(Gas, gas_lambda)),
    snaive = SNAIVE(box_cox(Gas, gas_lambda)),
    drift = RW(box_cox(Gas, gas_lambda) ~ drift()),
    stlf = decomposition_model (
      STL(box_cox(Gas, gas_lambda), robust = TRUE),
      SNAIVE(season_year),
      RW(season_adjust ~ drift())
    )
  )

gas_fit_todos
```

```{r}
gas_fc_todos <- gas_fit_todos |>
  forecast(h = "3 years")

gas_fc_todos

gas_fc_todos |>
  autoplot(aus_production) +
  facet_wrap(vars(.model), scales = "free_y")

gas_fc_todos |>
  autoplot(aus_production, level = NULL, linewidth = 1)
```

### Métricas de error (Accuracy)

```{r}
gas_fc_todos |>
  accuracy(aus_production) |>
  arrange(RMSE)
```

El mejor modelo parece ser el SNAIVE. Vamos a utilizar este para hacer el pronóstico final.

```{r}
aus_production |>
  model(
    snaive = SNAIVE(box_cox(Gas, gas_lambda))
  ) |>
  forecast(h = "3 years") |>
  autoplot(aus_production)
```

#### Tests de Pormentau de Autocorrelación

La prueba de Box-Pierce:

```{r}
gas_aug |>
  features(.innov, box_pierce, lag = 10, dof = 0)
```

La prueba de Ljung-Box

```{r}
gas_aug |>
  features(.innov, ljung_box, lag = 10, dof = 0)
```
